{% extends "layout.html" %}
{% block title %}Config{% endblock %}
{% block head %}
  <script src="{{url_for('static', filename='jscolor.min.js')}}"></script>
{% endblock %}
{% block page %}
  <form id="config" action="" method="POST">
    <fieldset>
      <legend>Income Sources</legend>
      <table id="income_sources">
        <thead>
          <tr>
            <th>Label</th>
            <th width="80">Amount</th>
            <th>Match</th>
            <th width="100">From</th>
            <th width="100">To</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for src in income_sources %}
          <tr>
            <td><input type="text" value="{{src.label}}" name="income_sources_label" required></td>
            <td><input type="number" value="{{src.amount}}" name="income_sources_amount" required step="any"></td>
            <td><input type="text" value="{{src.match or ''}}" name="income_sources_match"></td>
            <td><input type="date" value="{{src.from_date.isoformat() if src.from_date else ''}}" name="income_sources_from_date"></td>
            <td><input type="date" value="{{src.to_date.isoformat() if src.to_date else ''}}" name="income_sources_to_date"></td>
            <td><button type="button" onclick="removeRow(event)">&odash;</button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <template id="income_sources_row">
        <tr>
          <td><input type="text" value="" name="income_sources_label" required></td>
          <td><input type="number" value="" name="income_sources_amount" required step="any"></td>
          <td><input type="text" value="" name="income_sources_match"></td>
          <td><input type="date" value="" name="income_sources_from_date"></td>
          <td><input type="date" value="" name="income_sources_to_date"></td>
          <td><button type="button" onclick="removeRow(event)">&odash;</button></td>
        </tr>
      </template>
      <button type="button" onclick="addTemplateRow('income_sources')">&oplus; Add</button>
    </fieldset>
    <fieldset>
      <legend>Planned Expenses</legend>
      <table id="planned_expenses">
        <thead>
          <tr>
            <th>Label</th>
            <th width="100">Amount</th>
            <th>Recurrence</th>
            <th>Match</th>
            <th>From</th>
            <th>To</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for exp in planned_expenses %}
          <tr>
            <td><input type="text" value="{{exp.label}}" name="planned_expenses_label" required></td>
            <td><input type="number" value="{{exp.amount}}" name="planned_expenses_amount" required></td>
            <td>
              <select name="planned_expenses_recurrence">
                {% for recur in ('Weekly', 'Monthly', 'Yearly') %}
                <option value="{{recur|upper}}" {% if recur|upper == exp.recurrence_label %}selected{% endif %}>{{recur}}</option>
                {% endfor %}
              </select>
            </td>
            <td><input type="text" value="{{exp.match or ''}}" name="planned_expenses_match"></td>
            <td><input type="date" value="{{exp.from_date.isoformat() if exp.from_date else ''}}" name="planned_expenses_from_date"></td>
            <td><input type="date" value="{{exp.to_date.isoformat() if exp.to_date else ''}}" name="planned_expenses_to_date"></td>
            <td><button type="button" onclick="removeRow(event)">&odash;</button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <template id="planned_expenses_row">
        <tr>
          <td><input type="text" value="" name="planned_expenses_label" required></td>
          <td><input type="number" value="" name="planned_expenses_amount" required></td>
          <td>
            <select name="planned_expenses_recurrence">
              {% for recur in ('Weekly', 'Monthly', 'Yearly') %}
              <option value="{{recur|upper}}">{{recur}}</option>
              {% endfor %}
            </select>
          </td>
          <td><input type="text" value="" name="planned_expenses_match"></td>
          <td><input type="date" value="" name="planned_expenses_from_date"></td>
          <td><input type="date" value="" name="planned_expenses_to_date"></td>
          <td><button type="button" onclick="removeRow(event)">&odash;</button></td>
        </tr>
      </template>
      <button type="button" onclick="addTemplateRow('planned_expenses')">&oplus; Add</button>
    </fieldset>
    <fieldset>
      <legend>Budget Goals (per year)</legend>
      <table id="budget_goals">
        <thead>
          <tr>
            <th>Label</th>
            <th width="100">Amount</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for goal in budget_goals %}
          <tr>
            <td><input type="text" value="{{goal.label}}" name="budget_goals_label" required></td>
            <td><input type="number" value="{{goal.amount}}" name="budget_goals_amount" required></td>
            <td><button type="button" onclick="removeRow(event)">&odash;</button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <template id="budget_goals_row">
        <tr>
          <td><input type="text" value="" name="budget_goals_label" required></td>
          <td><input type="number" value="" name="budget_goals_amount" required></td>
          <td><button type="button" onclick="removeRow(event)">&odash;</button></td>
        </tr>
      </template>
      <button type="button" onclick="addTemplateRow('budget_goals')">&oplus; Add</button>
    </fieldset>
    <fieldset>
      <legend>Categories</legend>
      <table id="categories">
        <thead>
          <tr>
            <th width="150">Name</th>
            <th width="100">Color</th>
            <th>Keywords</th>
            <th width="150">Warn. threshold</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for category in categories %}
          <tr>
            <td><input type="text" value="{{category.name}}" name="categories_name" required></td>
            <td><input type="text" class="jscolor" value="{{category.color}}" name="categories_color"></td>
            <td><input type="text" value="{{", ".join(category.keywords)}}" name="categories_keywords"></td>
            <td><input type="number" value="{{category.warning_threshold}}" name="categories_warning_threshold" step="any"></td>
            <td><button type="button" onclick="removeRow(event)">&odash;</button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <template id="categories_row">
        <tr>
          <td><input type="text" value="" name="categories_name" required></td>
          <td><input type="text" class="jscolor" value="" name="categories_color"></td>
          <td><input type="text" value="" name="categories_keywords"></td>
          <td><input type="number" value="" name="categories_warning_threshold" step="any"></td>
          <td><button type="button" onclick="removeRow(event)">&odash;</button></td>
        </tr>
      </template>
      <button type="button" onclick="addTemplateRow('categories')">&oplus; Add</button>
    </fieldset>
    <button type="submit">Save</button>
  </form>
  <script>
    function addTemplateRow(tableId) {
      var tpl = document.querySelector('#' + tableId + '_row');
      var table = document.querySelector('#' + tableId + ' tbody');
      table.appendChild(document.importNode(tpl.content, true));
      table.querySelectorAll('input.jscolor').forEach(function(node) {
        new jscolor(node);
      });
    }

    function removeRow(event) {
      var tr = event.target.parentNode.parentNode;
      tr.parentNode.removeChild(tr);
    }
  </script>
{% endblock %}